---
# Various factors have led to this hack.
# * We have no good way of sharing the general ansible applied to the cluster 
#   before handing them over to this project.
# * System administrators should use their real id when configuring the cloud, 
#   but the current Slurm installation by NVIDIA DEEPOPS seems to break pam and thereby said logins. 
#   (Users don't need to access the compute nodes anyways, so not a dealbreaker)
# * Updating to the latest Slurm (21.08 at the moment) makes DEEPOPS unable to build Slurm.
# * Dropping DEEPOPS extends this project scope quite a bit: 
#   We would lose a lot of Nvidia knowledge and have to set up everything ourselves.
# * Dropping the pre-applied ansible also extends the scope: 
#   Aicloud would have to deal with active directory logins and configuration.
#
# The easiest path forward is adding a service account and just letting ad logins break on compute nodes.
#
# FIXME: revisit this in the future ...
#
- name: serviceuser
  hosts: all
  tasks:
    - name: add serviceuser
      user:
        name: serviceuser
        home: /serviceuser # outside of /home
        skeleton: /etc/skel
        shell: /bin/bash

    - name: allow serviceuser to sudo without password
      copy:
        dest: /etc/sudoers.d/serviceuser
        content: serviceuser ALL=(ALL) NOPASSWD:ALL
        mode: 0440

    - name: clear authorized_keys
      file:
        state: absent
        dest: /serviceuser/.ssh/authorized_keys

    - name: add authorized_keys
      authorized_key:
        user: serviceuser
        state: present
        key: '{{ item }}'
      with_items:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCjrqorlR39Vc+cxyrPu29EblMifDLBMum7nLzWXhzqcB4gXXVqU3Bnlzp+BVhWFzXe15XY+nBQErVx+sETkei8gouDueDxu0mgUM1QAOSnhQoGBSuJ4E8y39NuFDVO+ddGG8d+SqUJ5hllfEA6tjNT/WYgE18vVjjZD0W1QC8K/dcqdlKSLxDH9dqoBbvCyse2ZAJzOawEl7VLuvslopN6Z+aOOb8f/vMOd5QnqeL3w1yf0YN4d+R/vYikkgJJQSu/TsUjn9vPKmrJFzs9Tzxv9qyGDgFST9Irneyx7c95LjsDn0qvmrBBNgRQdkejmvmjaqW/2ryfxJkENmE/aSO9 tha@tha-colfax
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEJBwGK1quixwloL4ESw63jjnj20gL7tYEGhTWEkBK7Q emergency-keypair-from-pwstate
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMc+8YWa+5nfUkWXuRPU+iVfFE30sAqUqfVmtggN5PsP AI-Cloud
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICy9WIsEo6WXJGmQDcMulXSpEPkcR5+EnZbg+T0dEPu4 chrwahl
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC0CXNJVrKElGWsRLzrT6Xmckz4KALTX2GwK/fWimwTOTO0SgFii/tPeq1ViVg8KvmIQ/XoUPGv4cFNXlqCg2hcnwHhoh8xO3kFcXi3nAml1GoipxlqUSqlFh0wQJo11291n6/Vi9C1129F7cZDXHklDpOkF2ZjV3d2ZElzC6P5z/UP5LDLJ2elcbJHZq9UQeN54dPgg5+cZrk/nAHJd6PMrDcoTt09lrQM7NvjtXkkthh4IgOKRXm1MhXEHfSCDt7n9aQXwIOJ2RNrLSW29SHLOs0TxGUa5+zk7ZmxHhAODXcvIu/oylHt+TcoYuBvgXr0qsj9UdShwO1kU1u5VQHNU/QFokagRtRfbWYHmBllSKObwEzLv6Zu7bi+DQHkY80qfC0mX/7XG/Cg3KmBcL0g6h8/N+iHzqCYEzK/JeuVhMkckilgIsxPxNrIDvhn0fBP5S2+hl30nvjhdlo5i1AeHBdJ/veRDyFHxZk3JVN4yNThksJQbKmrdiBDVfCjFLM= 
