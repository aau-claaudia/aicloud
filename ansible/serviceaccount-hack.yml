---
# Various factors have led to this hack.
# * We have no good way of sharing the general ansible applied to the cluster 
#   before handing them over to this project.
# * System administrators should use their real id when configuring the cloud, 
#   but the current Slurm installation by NVIDIA DEEPOPS seems to break pam and thereby said logins. 
#   (Users don't need to access the compute nodes anyways, so not a dealbreaker)
# * Updating to the latest Slurm (21.08 at the moment) makes DEEPOPS unable to build Slurm.
# * Dropping DEEPOPS extends this project scope quite a bit: 
#   We would lose a lot of Nvidia knowledge and have to set up everything ourselves.
# * Dropping the pre-applied ansible also extends the scope: 
#   Aicloud would have to deal with active directory logins and configuration.
#
# The easiest path forward is adding a service account and just letting ad logins break on compute nodes.
#
# FIXME: revisit this in the future ...
#
- name: serviceuser
  hosts: all
  tasks:
    - name: add serviceuser
      user:
        name: serviceuser
        home: /serviceuser # outside of /home
        skeleton: /etc/skel
        shell: /bin/bash

    - name: allow serviceuser to sudo without password
      copy:
        dest: /etc/sudoers.d/serviceuser
        content: serviceuser ALL=(ALL) NOPASSWD:ALL
        mode: 0440

    - name: clear authorized_keys
      file:
        state: absent
        dest: /serviceuser/.ssh/authorized_keys

    - name: add authorized_keys
      authorized_key:
        user: serviceuser
        state: present
        key: '{{ item }}'
      with_items:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCjrqorlR39Vc+cxyrPu29EblMifDLBMum7nLzWXhzqcB4gXXVqU3Bnlzp+BVhWFzXe15XY+nBQErVx+sETkei8gouDueDxu0mgUM1QAOSnhQoGBSuJ4E8y39NuFDVO+ddGG8d+SqUJ5hllfEA6tjNT/WYgE18vVjjZD0W1QC8K/dcqdlKSLxDH9dqoBbvCyse2ZAJzOawEl7VLuvslopN6Z+aOOb8f/vMOd5QnqeL3w1yf0YN4d+R/vYikkgJJQSu/TsUjn9vPKmrJFzs9Tzxv9qyGDgFST9Irneyx7c95LjsDn0qvmrBBNgRQdkejmvmjaqW/2ryfxJkENmE/aSO9 tha@tha-colfax
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEJBwGK1quixwloL4ESw63jjnj20gL7tYEGhTWEkBK7Q emergency-keypair-from-pwstate
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMc+8YWa+5nfUkWXuRPU+iVfFE30sAqUqfVmtggN5PsP AI-Cloud
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICy9WIsEo6WXJGmQDcMulXSpEPkcR5+EnZbg+T0dEPu4 chrwahl
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCTWhirhW3Qg6Qo19iiMWHfvbtkwC9grsjOBkRQnueGnMTWVC3CA2J+1lbT5m2WviaECmMBnc43FCOII6c9FR8SL0rYkpkB/r6cCKJqt7F5aDki/6M6mw8zeb1oUQE9Pu8u0tJUx133JYm/T1d6O3CkZZNvUDljFI+ZG8xvNswnGmtJRbTm1AGNyKY4Gor/CMMnin9UoJiRgqvYqHaWqJLfMiawyrW18VN0eH99Iw5Ave2No0JYIb29dzaA0n+DXiHz7FIF+LN58Tv5fDkooAoJJBxlDMEjxOD966CkgN/4ScGmkTo5oRNasSEZ/05J34J69QfuQcDUs+vs7hgC1QHR19aC2lNCsNcBEgDuqbPwKhWS8RkT/nJS6wL++ljSDQ/OmtbyQNqb7UZdOj9gUkpCG1yGGIk630kN3vgtKwB6o8Dy9PKwQ218vbMrm6zDBgFMJMSAmYyo9wxjk6oS93l5ZOjBPp12Si/+h9SSkxSK15JTIHina4Y0gqVH0XouZE0= 
